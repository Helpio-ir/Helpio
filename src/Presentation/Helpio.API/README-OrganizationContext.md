# OrganizationContext - ????? ??? ????

## ????? ????? ? ??????? ?? OrganizationContext

### 1. **??? ???????? ?? Program.cs**
```csharp
// HttpContextAccessor ???? ?????? ?? HttpContext
builder.Services.AddHttpContextAccessor();

// OrganizationContext service
builder.Services.AddScoped<IOrganizationContext, OrganizationContext>();
```

### 2. **????? ???? Middleware**
```csharp
// ??? ?? UseAuthorization ???? ????? ???
app.UseMiddleware<ApiKeyAuthenticationMiddleware>();
app.UseAuthorization();
```

## ????? ???????

### ????? 1: **???? ???????**
```
????? ??????? ???????? ?? header:
X-API-Key: your-api-key-here
```

### ????? 2: **ApiKeyAuthenticationMiddleware**
```csharp
public async Task InvokeAsync(HttpContext context, IApiKeyService apiKeyService)
{
    // 1. ??????? API Key ?? header
    if (!context.Request.Headers.TryGetValue("X-API-Key", out var extractedApiKey))
    {
        return Unauthorized(); // ? ??? API Key ?????
    }

    // 2. ?????????? API Key
    var isValid = await apiKeyService.ValidateApiKeyAsync(apiKey, clientIp);
    if (!isValid)
    {
        return Unauthorized(); // ? ??? API Key ??????? ????
    }

    // 3. ?????? ?????? API Key
    var apiKeyDetails = await apiKeyService.GetByKeyValueAsync(apiKey);
    
    // 4. ????? Claims ? ????? User
    var claims = new List<Claim>
    {
        new("OrganizationId", apiKeyDetails.OrganizationId.ToString()), // ?? ???!
        new("OrganizationName", apiKeyDetails.Organization.Name),
        new("ApiKeyId", apiKeyDetails.Id.ToString()),
        new("AuthenticationType", "ApiKey")
    };

    context.User = new ClaimsPrincipal(new ClaimsIdentity(claims, "ApiKey"));
    
    // 5. ????? pipeline
    await _next(context);
}
```

### ????? 3: **OrganizationContext ?????? Claims**
```csharp
public class OrganizationContext : IOrganizationContext
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public int? OrganizationId
    {
        get
        {
            // ?????? OrganizationId ?? Claims ?? ?? middleware ????? ???
            var orgIdClaim = _httpContextAccessor.HttpContext?.User?.FindFirst("OrganizationId")?.Value;
            return int.TryParse(orgIdClaim, out var orgId) ? orgId : null;
        }
    }

    public bool IsAuthenticated =>
        _httpContextAccessor.HttpContext?.User?.Identity?.IsAuthenticated ?? false;
}
```

### ????? 4: **??????? ?? Controllers**
```csharp
[ApiController]
public class ArticlesController : ControllerBase
{
    private readonly IOrganizationContext _organizationContext;

    // Dependency Injection
    public ArticlesController(IOrganizationContext organizationContext, ...)
    {
        _organizationContext = organizationContext;
    }

    [HttpGet]
    public async Task<ActionResult> GetArticles()
    {
        // ??????? ?? OrganizationContext
        if (!_organizationContext.IsAuthenticated)
        {
            return Unauthorized(); // ?
        }

        if (!_organizationContext.OrganizationId.HasValue)
        {
            return BadRequest("Organization context not found"); // ?
        }

        // ? ?????? ?? OrganizationId
        var orgId = _organizationContext.OrganizationId.Value;
        
        // ??? ?????? ???? ??????
        var articles = await _articlesService.GetByOrganizationIdAsync(orgId);
        return Ok(articles);
    }
}
```

## ???? ???

### ? **?????:**
- **Multi-tenant**: ?? API Key ????? ?? ?? ??????
- **?????**: ?????? ??? ?? ???????? ?????? ????
- **?????**: ?????? ???? ?? ???? ????????

### ?? **???? ??????:**
- API Key ???? ?? header `X-API-Key` ????? ???
- Claims ??? ???? API Key ??? ????? ????? ??????
- ??? API Key ??????? ????? `IsAuthenticated = false`

### ?? **??????? Skip ???:**
```csharp
// ??? ?????? ???? ?? API Key ??????
/health, /swagger, /api/docs, /
```

## ???? ???? ???????

```bash
# ??????? ?????
curl -H "X-API-Key: your-valid-api-key" \
     https://api.helpio.com/api/articles

# ?????:
# - API Key validate ??????
# - OrganizationId ?? API Key ????? ??????  
# - ??? ?????? ???? ?????? ????????? ??????
```

```bash
# ??????? ???? API Key
curl https://api.helpio.com/api/articles

# ?????: 401 Unauthorized
```

## ????? ?????:
```
??????? ? ApiKeyAuthenticationMiddleware ? Claims ????? ? OrganizationContext ? Controller
```