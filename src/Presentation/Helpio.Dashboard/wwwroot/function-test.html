<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Functions Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result { margin: 5px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body class="container mt-4">
    <h2>JavaScript Functions Test</h2>
    <div id="results"></div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <h4>Test Elements</h4>
            <textarea id="responseContent" class="form-control" rows="3" placeholder="Test content here...">سلام {نام_مشتری}</textarea>
            <input id="tagsInput" name="Tags" class="form-control mt-2" placeholder="Tags...">
            <div id="previewContent" class="border p-3 mt-2 bg-light" style="min-height: 100px;">Preview here...</div>
        </div>
        
        <div class="col-md-6">
            <h4>Test Buttons</h4>
            <div class="d-grid gap-2">
                <button class="btn btn-primary" onclick="testInsertVariable()">Test Insert Variable</button>
                <button class="btn btn-success" onclick="testAddTag()">Test Add Tag</button>
                <button class="btn btn-info" onclick="testUseTemplate()">Test Use Template</button>
                <button class="btn btn-warning" onclick="testUpdatePreview()">Test Update Preview</button>
                <button class="btn btn-secondary" onclick="testResponseWindow()">Test Response Window</button>
                <button class="btn btn-dark" onclick="runAllTests()">Run All Tests</button>
            </div>
        </div>
    </div>

    <script>
        // Copy the exact same JavaScript from CreateCannedResponse
        (function() {
            'use strict';
            
            console.log('Test page: Initializing JavaScript...');
            
            // Templates
            var templates = {
                greeting: "سلام {نام_مشتری} عزیز،\n\nامیدوارم حال شما خوب باشد.",
                closing: "با تشکر،\n{نام_کارشناس}\nتیم پشتیبانی"
            };
            
            // Global functions - exactly the same as in CreateCannedResponse
            window.insertVariable = function(variable) {
                var textarea = document.getElementById('responseContent');
                if (textarea) {
                    var pos = textarea.selectionStart;
                    var val = textarea.value;
                    textarea.value = val.slice(0, pos) + variable + val.slice(textarea.selectionEnd);
                    textarea.setSelectionRange(pos + variable.length, pos + variable.length);
                    textarea.focus();
                    updatePreview();
                    return 'SUCCESS';
                }
                return 'ERROR: Textarea not found';
            };
            
            window.addTag = function(tag) {
                var input = document.getElementById('tagsInput');
                if (input) {
                    var current = input.value.trim();
                    if (current && current.split(',').map(function(t) { return t.trim(); }).indexOf(tag) === -1) {
                        input.value = current + ', ' + tag;
                    } else if (!current) {
                        input.value = tag;
                    }
                    return 'SUCCESS';
                }
                return 'ERROR: Tags input not found';
            };
            
            window.useTemplate = function(name) {
                var textarea = document.getElementById('responseContent');
                if (textarea && templates[name]) {
                    textarea.value = templates[name];
                    updatePreview();
                    return 'SUCCESS';
                }
                return 'ERROR: Textarea or template not found';
            };
            
            window.updatePreview = function() {
                var textarea = document.getElementById('responseContent');
                var preview = document.getElementById('previewContent');
                if (textarea && preview) {
                    var content = textarea.value;
                    if (content.trim()) {
                        var html = content
                            .replace(/{نام_مشتری}/g, '<span class="text-primary fw-bold">احمد محمدی</span>')
                            .replace(/{شماره_تیکت}/g, '<span class="text-info fw-bold">#12345</span>')
                            .replace(/{نام_شرکت}/g, '<span class="text-success fw-bold">شرکت نمونه</span>')
                            .replace(/{تاریخ_امروز}/g, '<span class="text-warning fw-bold">' + new Date().toLocaleDateString('fa-IR') + '</span>')
                            .replace(/{نام_کارشناس}/g, '<span class="text-secondary fw-bold">علی رضایی</span>')
                            .replace(/\n/g, '<br>');
                        preview.innerHTML = '<div>' + html + '</div>';
                    } else {
                        preview.innerHTML = '<div class="text-muted">No content</div>';
                    }
                    return 'SUCCESS';
                }
                return 'ERROR: Elements not found';
            };
            
            window.testResponse = function() {
                var textarea = document.getElementById('responseContent');
                if (!textarea || !textarea.value.trim()) {
                    return 'ERROR: No content';
                }
                
                var content = textarea.value;
                var html = content
                    .replace(/{نام_مشتری}/g, '<strong style="color: #0d6efd;">احمد محمدی</strong>')
                    .replace(/\n/g, '<br>');
                
                var win = window.open('', '_blank', 'width=500,height=400');
                if (win) {
                    win.document.write('<!DOCTYPE html><html dir="rtl"><head><meta charset="utf-8"><title>Test Response</title></head><body class="p-4"><div>' + html + '</div><br><button onclick="window.close()">بستن</button></body></html>');
                    win.document.close();
                    return 'SUCCESS';
                }
                return 'ERROR: Popup blocked';
            };
            
            // Test functions
            window.testInsertVariable = function() {
                var result = insertVariable('{نام_مشتری}');
                logResult('Insert Variable Test', result);
            };
            
            window.testAddTag = function() {
                var result = addTag('تست');
                logResult('Add Tag Test', result);
            };
            
            window.testUseTemplate = function() {
                var result = useTemplate('greeting');
                logResult('Use Template Test', result);
            };
            
            window.testUpdatePreview = function() {
                var result = updatePreview();
                logResult('Update Preview Test', result);
            };
            
            window.testResponseWindow = function() {
                var result = testResponse();
                logResult('Test Response Window', result);
            };
            
            window.runAllTests = function() {
                document.getElementById('results').innerHTML = '<h4>Running All Tests...</h4>';
                
                // Function availability test
                var functions = ['insertVariable', 'addTag', 'useTemplate', 'updatePreview', 'testResponse'];
                functions.forEach(function(funcName) {
                    var available = typeof window[funcName] === 'function';
                    logResult(funcName + ' Availability', available ? 'SUCCESS' : 'ERROR: Not found');
                });
                
                // Functional tests
                setTimeout(function() {
                    testUpdatePreview();
                    setTimeout(function() { testInsertVariable(); }, 200);
                    setTimeout(function() { testAddTag(); }, 400);
                    setTimeout(function() { testUseTemplate(); }, 600);
                }, 500);
            };
            
            function logResult(testName, result) {
                var resultsDiv = document.getElementById('results');
                var className = result.startsWith('SUCCESS') ? 'success' : 'error';
                var time = new Date().toLocaleTimeString();
                resultsDiv.innerHTML += '<div class="test-result ' + className + '">[' + time + '] <strong>' + testName + ':</strong> ' + result + '</div>';
            }
            
            // Initialize
            function init() {
                console.log('Test page: DOM ready, setting up...');
                
                var textarea = document.getElementById('responseContent');
                if (textarea) {
                    textarea.addEventListener('input', updatePreview);
                }
                
                updatePreview();
                
                logResult('Initialization', 'SUCCESS');
                console.log('Test page: Setup complete!');
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();
    </script>
</body>
</html>