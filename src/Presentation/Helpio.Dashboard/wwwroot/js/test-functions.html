<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test JavaScript Functions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4>Test JavaScript Functions</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="testContent" class="form-label">Test Content</label>
                            <textarea id="testContent" class="form-control" rows="5" placeholder="Type here to test..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Test Variable Insertion</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="testInsertVariable('{نام_مشتری}')">
                                    نام مشتری
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="testInsertVariable('{شماره_تیکت}')">
                                    شماره تیکت
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Test Templates</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="testUseTemplate('greeting')">
                                    Greeting
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="testUseTemplate('closing')">
                                    Closing
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-info" onclick="testUpdatePreview()">
                                Test Update Preview
                            </button>
                            <button type="button" class="btn btn-success" onclick="testResponseWindow()">
                                Test Response Window
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="testPreview" class="border rounded p-3 bg-white min-height-150">
                            Preview will appear here...
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults" class="small">
                            <div class="text-muted">Test results will appear here...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test templates
        const testTemplates = {
            greeting: "سلام {نام_مشتری} عزیز،\n\nامیدوارم حال شما خوب باشد.",
            closing: "با تشکر،\n{نام_کارشناس}\nتیم پشتیبانی"
        };

        function logTest(functionName, success, message) {
            const results = document.getElementById('testResults');
            const time = new Date().toLocaleTimeString();
            const status = success ? '✅' : '❌';
            const color = success ? 'text-success' : 'text-danger';
            
            results.innerHTML += `
                <div class="${color}">
                    ${status} [${time}] ${functionName}: ${message}
                </div>
            `;
            results.scrollTop = results.scrollHeight;
        }

        function testInsertVariable(variable) {
            try {
                const textarea = document.getElementById('testContent');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                
                textarea.value = text.substring(0, start) + variable + text.substring(end);
                textarea.focus();
                textarea.setSelectionRange(start + variable.length, start + variable.length);
                
                logTest('insertVariable', true, `Inserted: ${variable}`);
                testUpdatePreview();
            } catch (error) {
                logTest('insertVariable', false, error.message);
            }
        }

        function testUseTemplate(templateName) {
            try {
                if (!testTemplates[templateName]) {
                    throw new Error('Template not found: ' + templateName);
                }
                
                const textarea = document.getElementById('testContent');
                if (textarea.value.trim() && 
                    !confirm('Replace current content?')) {
                    return;
                }
                
                textarea.value = testTemplates[templateName];
                logTest('useTemplate', true, `Applied template: ${templateName}`);
                testUpdatePreview();
            } catch (error) {
                logTest('useTemplate', false, error.message);
            }
        }

        function testUpdatePreview() {
            try {
                const textarea = document.getElementById('testContent');
                const previewDiv = document.getElementById('testPreview');
                
                if (!textarea || !previewDiv) {
                    throw new Error('Required elements not found');
                }
                
                const content = textarea.value;
                
                if (content.trim()) {
                    let preview = content
                        .replace(/{نام_مشتری}/g, '<span class="text-primary fw-bold">احمد محمدی</span>')
                        .replace(/{شماره_تیکت}/g, '<span class="text-info fw-bold">#12345</span>')
                        .replace(/{نام_شرکت}/g, '<span class="text-success fw-bold">شرکت نمونه</span>')
                        .replace(/{تاریخ_امروز}/g, '<span class="text-warning fw-bold">' + new Date().toLocaleDateString('fa-IR') + '</span>')
                        .replace(/{نام_کارشناس}/g, '<span class="text-secondary fw-bold">علی رضایی</span>')
                        .replace(/\n/g, '<br>');
                    
                    previewDiv.innerHTML = preview;
                } else {
                    previewDiv.innerHTML = '<div class="text-muted">Preview will appear here...</div>';
                }
                
                logTest('updatePreview', true, 'Preview updated successfully');
            } catch (error) {
                logTest('updatePreview', false, error.message);
            }
        }

        function testResponseWindow() {
            try {
                const textarea = document.getElementById('testContent');
                const content = textarea.value;
                
                if (!content.trim()) {
                    throw new Error('No content to test');
                }
                
                const testWindow = window.open('', '_blank', 'width=600,height=400');
                if (!testWindow) {
                    throw new Error('Popup blocked');
                }
                
                testWindow.document.write(`
                    <html dir="rtl">
                    <head>
                        <title>Test Response</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    </head>
                    <body>
                        <div class="container mt-4">
                            <h4>Test Response Window</h4>
                            <div class="card">
                                <div class="card-body">
                                    ${content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <button class="btn btn-secondary" onclick="window.close()">Close</button>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                testWindow.document.close();
                
                logTest('testResponse', true, 'Test window opened successfully');
            } catch (error) {
                logTest('testResponse', false, error.message);
            }
        }

        // Auto-update preview
        document.getElementById('testContent').addEventListener('input', testUpdatePreview);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logTest('DOMContentLoaded', true, 'Test page initialized');
        });
    </script>

    <style>
        .min-height-150 {
            min-height: 150px;
        }
        
        #testResults {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</body>
</html>