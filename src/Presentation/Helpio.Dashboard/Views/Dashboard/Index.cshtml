@model Helpio.Dashboard.Models.DashboardStatsViewModel
@{
    ViewData["Title"] = "داشبورد اصلی";
    var subscriptionInfo = ViewBag.SubscriptionInfo as Helpio.Ir.Application.Services.Business.SubscriptionLimitInfo;
}

<!--begin::Row-->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">خوش آمدید @ViewBag.CurrentUser?.UserFullName</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h4>سیستم مدیریت پشتیبانی Helpio</h4>
                        <p>در این پنل می‌توانید تیکت‌ها، مشتریان و گزارش‌های خود را مدیریت کنید.</p>
                        
                        @if (ViewBag.CurrentOrganization != null)
                        {
                            <div class="alert alert-info">
                                <strong>سازمان شما:</strong> @ViewBag.CurrentOrganization.Name
                                @if (ViewBag.CurrentTeam != null)
                                {
                                    <br><strong>تیم شما:</strong> @ViewBag.CurrentTeam.Name
                                }
                            </div>
                        }
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="bi bi-shield-check text-primary" style="font-size: 4rem;"></i>
                            <h5>سیستم امن و قابل اعتماد</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (subscriptionInfo != null)
{
    <!-- Subscription Status Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-start @(subscriptionInfo.IsFreemium ? "border-warning" : "border-success") border-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-credit-card me-2"></i>
                            وضعیت اشتراک - @subscriptionInfo.PlanType.ToString()
                        </h5>
                    </div>
                    <div>
                        <a href="@Url.Action("Index", "Subscription")" class="btn btn-sm btn-outline-primary">
                            مدیریت اشتراک
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">@subscriptionInfo.CurrentMonthUsage</h4>
                                <small class="text-muted">تیکت ایجاد شده</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="@(subscriptionInfo.RemainingTickets <= 5 ? "text-danger" : "text-success")">@subscriptionInfo.RemainingTickets</h4>
                                <small class="text-muted">باقی‌مانده</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">@(subscriptionInfo.MonthlyLimit == int.MaxValue ? "∞" : subscriptionInfo.MonthlyLimit.ToString())</h4>
                                <small class="text-muted">حد مجاز ماهانه</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                @{
                                    var percentage = subscriptionInfo.MonthlyLimit > 0 ? Math.Round((double)subscriptionInfo.CurrentMonthUsage / subscriptionInfo.MonthlyLimit * 100, 1) : 0;
                                    var statusClass = subscriptionInfo.CanCreateTickets ? "text-success" : "text-danger";
                                }
                                <h4 class="@statusClass">@(subscriptionInfo.CanCreateTickets ? "فعال" : "غیرفعال")</h4>
                                <small class="text-muted">وضعیت ایجاد تیکت</small>
                            </div>
                        </div>
                    </div>
                    
                    @if (subscriptionInfo.MonthlyLimit > 0)
                    {
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>میزان استفاده ماهانه</span>
                                <span class="badge @(percentage >= 90 ? "bg-danger" : percentage >= 70 ? "bg-warning" : "bg-success")">@percentage%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar @(percentage >= 90 ? "bg-danger" : percentage >= 70 ? "bg-warning" : "bg-success")" 
                                     style="width: @percentage%"></div>
                            </div>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(subscriptionInfo.LimitationMessage))
                    {
                        <div class="alert @(subscriptionInfo.CanCreateTickets ? "alert-warning" : "alert-danger") mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @subscriptionInfo.LimitationMessage
                            @if (subscriptionInfo.IsFreemium)
                            {
                                <div class="mt-2">
                                    <a href="@Url.Action("Upgrade", "Subscription")" class="btn btn-sm btn-primary">
                                        ارتقا اشتراک
                                    </a>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!--begin::Stats Row-->
<div class="row">
    @if (ViewBag.IsAdmin == true || ViewBag.IsManager == true)
    {
        <div class="col-lg-3 col-6">
            <div class="small-box text-bg-info">
                <div class="inner">
                    <h3>@Model.TotalTickets</h3>
                    <p>کل تیکت‌ها</p>
                </div>
                <div class="small-box-icon">
                    <i class="bi bi-ticket-detailed"></i>
                </div>
                <a asp-controller="Tickets" asp-action="Index" class="small-box-footer link-light">
                    مشاهده بیشتر <i class="bi bi-arrow-left"></i>
                </a>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="small-box text-bg-success">
                <div class="inner">
                    <h3>@Model.ClosedTickets</h3>
                    <p>تیکت‌های بسته شده</p>
                </div>
                <div class="small-box-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <a asp-controller="Reports" asp-action="TicketReport" class="small-box-footer link-light">
                    مشاهده بیشتر <i class="bi bi-arrow-left"></i>
                </a>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="small-box text-bg-warning">
                <div class="inner">
                    <h3>@Model.OpenTickets</h3>
                    <p>تیکت‌های باز</p>
                </div>
                <div class="small-box-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <a asp-controller="Tickets" asp-action="Index" class="small-box-footer link-dark">
                    مشاهده بیشتر <i class="bi bi-arrow-left"></i>
                </a>
            </div>
        </div>

        <div class="col-lg-3 col-6">
            <div class="small-box text-bg-danger">
                <div class="inner">
                    <h3>@Model.TotalCustomers</h3>
                    <p>مشتریان</p>
                </div>
                <div class="small-box-icon">
                    <i class="bi bi-people"></i>
                </div>
                <a asp-controller="Customers" asp-action="Index" class="small-box-footer link-light">
                    مشاهده بیشتر <i class="bi bi-arrow-left"></i>
                </a>
            </div>
        </div>
    }
    else if (ViewBag.IsAgent == true)
    {
        <div class="col-lg-4 col-6">
            <div class="small-box text-bg-primary">
                <div class="inner">
                    <h3>@Model.MyTickets</h3>
                    <p>تیکت‌های من</p>
                </div>
                <div class="small-box-icon">
                    <i class="bi bi-person-check"></i>
                </div>
                <a asp-controller="Tickets" asp-action="Index" class="small-box-footer link-light">
                    مشاهده بیشتر <i class="bi bi-arrow-left"></i>
                </a>
            </div>
        </div>

        <div class="col-lg-4 col-6">
            <div class="small-box text-bg-success">
                <div class="inner">
                    <h3>@Model.ClosedTickets</h3>
                    <p>تیکت‌های بسته شده</p>
                </div>
                <div class="small-box-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <a href="#" class="small-box-footer link-light">
                    مشاهده بیشتر <i class="bi bi-arrow-left"></i>
                </a>
            </div>
        </div>

        <div class="col-lg-4 col-6">
            <div class="small-box text-bg-warning">
                <div class="inner">
                    <h3>@Model.OpenTickets</h3>
                    <p>تیکت‌های باز</p>
                </div>
                <div class="small-box-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <a asp-controller="Tickets" asp-action="Index" class="small-box-footer link-dark">
                    مشاهده بیشتر <i class="bi bi-arrow-left"></i>
                </a>
            </div>
        </div>
    }
</div>

<!--begin::Quick Actions-->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">عملیات سریع</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    @if (ViewBag.IsAdmin == true || ViewBag.IsManager == true)
                    {
                        <div class="col-md-3 mb-3">
                            @if (subscriptionInfo?.CanCreateTickets == true)
                            {
                                <a asp-controller="Tickets" asp-action="Create" class="btn btn-primary btn-lg w-100">
                                    <i class="bi bi-plus-circle"></i>
                                    <br>ایجاد تیکت جدید
                                </a>
                            }
                            else
                            {
                                <button class="btn btn-secondary btn-lg w-100" disabled title="محدودیت اشتراک">
                                    <i class="bi bi-plus-circle"></i>
                                    <br>ایجاد تیکت جدید
                                    <br><small>(محدود شده)</small>
                                </button>
                            }
                        </div>
                        <div class="col-md-3 mb-3">
                            <a asp-controller="Customers" asp-action="Create" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-person-plus"></i>
                                <br>افزودن مشتری
                            </a>
                        </div>
                    }
                    
                    <div class="col-md-3 mb-3">
                        <a asp-controller="Tickets" asp-action="Index" class="btn btn-info btn-lg w-100">
                            <i class="bi bi-list-check"></i>
                            <br>مشاهده تیکت‌ها
                        </a>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <a asp-controller="Reports" asp-action="Index" class="btn btn-warning btn-lg w-100">
                            <i class="bi bi-bar-chart"></i>
                            <br>گزارشات
                        </a>
                    </div>
                    
                    @if (subscriptionInfo != null)
                    {
                        <div class="col-md-3 mb-3">
                            <a asp-controller="Subscription" asp-action="Status" class="btn btn-outline-primary btn-lg w-100">
                                <i class="bi bi-credit-card"></i>
                                <br>وضعیت اشتراک
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!--begin::Role Information-->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">اطلاعات نقش و دسترسی</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>نقش</th>
                                <th>ایمیل</th>
                                <th>رمز عبور</th>
                                <th>دسترسی‌ها</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="@(ViewBag.IsAdmin == true ? "table-danger" : "")">
                                <td><span class="badge bg-danger">Admin</span></td>
                                <td>admin@helpio.ir</td>
                                <td>Admin123!</td>
                                <td>مدیریت کامل سیستم، همه سازمان‌ها و تیم‌ها</td>
                            </tr>
                            <tr class="@(ViewBag.IsManager == true ? "table-warning" : "")">
                                <td><span class="badge bg-warning">Manager</span></td>
                                <td>manager@helpio.ir</td>
                                <td>Manager123!</td>
                                <td>مدیریت سازمان و تیم‌های مربوطه</td>
                            </tr>
                            <tr class="@(ViewBag.IsAgent == true ? "table-success" : "")">
                                <td><span class="badge bg-success">Agent</span></td>
                                <td>agent@helpio.ir</td>
                                <td>Agent123!</td>
                                <td>مدیریت تیکت‌های اختصاص داده شده</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <small class="text-muted">
                    * ردیف برجسته شده نقش فعلی شما را نشان می‌دهد
                </small>
            </div>
        </div>
    </div>
</div>